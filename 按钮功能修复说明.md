# 按钮功能修复说明

## 问题描述
原代码中除了"选择文件夹"按钮外，其他按钮（批量重命名、导出到CSV、转为CMYK、转为RGB、刷新）都无法正常工作。

## 主要问题

### 1. **线程间通信不完整**
- `load_folder` 函数扫描文件夹后，没有将结果发送回主线程
- 后台任务完成后，主线程无法获知结果

### 2. **缺少实际处理逻辑**
- `execute_rename` 和 `execute_convert` 只是模拟延迟，没有调用实际的处理函数
- `execute_export` 虽然调用了导出函数，但没有正确处理结果

### 3. **函数签名不匹配**
- `batch_rename_by_size` 需要 `image_infos` 参数
- `batch_convert_color_mode` 需要 `folder_path`、`output_folder`、`image_infos` 和 `target_mode` 四个参数
- 这些函数返回 `Result<Vec<(String, String)>>` 而不是 `Result<()>`

### 4. **状态管理混乱**
- 状态更新逻辑在 `update` 函数中模拟进度，但实际数据没有更新
- 导致按钮状态和实际功能不同步

## 修复方案

### 1. **完善消息枚举**
添加了更多消息类型以支持完整的线程间通信：
```rust
enum AppMessage {
    FolderSelected(PathBuf),
    LoadComplete(Result<BatchImageInfo, String>),  // 新增
    RenameRequested,
    RenameComplete(Result<(), String>),            // 新增
    ExportRequested,
    ExportComplete(Result<(), String>),            // 新增
    ConvertRequested(String),
    ConvertComplete(Result<(), String>),           // 新增
    RefreshRequested,
    Error(String),                                 // 新增
}
```

### 2. **修复 `load_folder` 函数**
现在正确地将扫描结果发送回主线程：
```rust
thread::spawn(move || {
    let result = scan_folder(&folder_path)
        .map_err(|e| e.to_string());
    
    let _ = tx.send(AppMessage::LoadComplete(result));
    ctx_clone.request_repaint();
});
```

### 3. **修复 `execute_rename` 函数**
调用实际的重命名函数：
```rust
thread::spawn(move || {
    let result = batch_rename_by_size(&folder_path, &batch_info.images)
        .map(|_| ())
        .map_err(|e| e.to_string());
    
    let _ = tx.send(AppMessage::RenameComplete(result));
    ctx_clone.request_repaint();
});
```

### 4. **修复 `execute_convert` 函数**
调用实际的色彩转换函数，并创建输出文件夹：
```rust
thread::spawn(move || {
    let output_folder = folder_path.join(format!("converted_{}", target_mode));
    
    let result = batch_convert_color_mode(&folder_path, &output_folder, &batch_info.images, &target_mode)
        .map(|_| ())
        .map_err(|e| e.to_string());
    
    let _ = tx.send(AppMessage::ConvertComplete(result));
    ctx_clone.request_repaint();
});
```

### 5. **完善 `process_messages` 函数**
处理所有消息类型，正确更新状态和数据：
```rust
AppMessage::LoadComplete(result) => {
    match result {
        Ok(batch_info) => {
            self.batch_info = Some(batch_info.clone());
            self.state = AppState::Idle;
            self.status_message = format!("加载完成：共 {} 张图片...", ...);
            self.progress = 1.0;
        }
        Err(e) => {
            self.state = AppState::Idle;
            self.error_message = Some(format!("加载失败: {}", e));
        }
    }
}
// ... 类似处理其他消息
```

### 6. **改进 UI 反馈**
- 移除了模拟进度更新逻辑
- 在处理中显示 spinner
- 完成后显示详细的状态信息
- 错误时弹出错误对话框

## 功能说明

### 选择文件夹
- 打开文件夹选择对话框
- 扫描文件夹中的所有图片
- 显示图片列表和统计信息

### 批量重命名
- 根据图片的物理尺寸（厘米）重命名文件
- 格式：`宽度x高度_原文件名.扩展名`
- 完成后自动刷新列表

### 导出到CSV
- 将图片信息导出为 CSV 文件
- 包含文件名、像素尺寸、物理尺寸、DPI、色彩模式、文件大小等信息

### 转为CMYK/RGB
- 转换图片的色彩模式
- 转换后的图片保存在 `converted_CMYK` 或 `converted_RGB` 文件夹中
- 完成后自动刷新列表

### 刷新
- 重新扫描当前文件夹
- 更新图片列表

## 测试建议

1. **选择文件夹**：选择一个包含图片的文件夹，确认能正确加载
2. **批量重命名**：测试重命名功能，检查文件名是否按预期更改
3. **导出CSV**：导出并打开 CSV 文件，确认数据正确
4. **色彩转换**：测试 CMYK 和 RGB 转换，检查输出文件夹
5. **刷新**：修改文件夹内容后，测试刷新功能

## 运行程序

```bash
# 编译发布版本
cargo build --release

# 运行程序
./target/release/image-info-tool
```

## 注意事项

1. 色彩转换会在原文件夹下创建 `converted_CMYK` 或 `converted_RGB` 子文件夹
2. 批量重命名会直接修改原文件名，建议先备份
3. 所有操作都在后台线程执行，不会阻塞 UI
4. 处理过程中会显示 spinner，完成后显示结果消息
