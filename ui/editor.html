<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电子书编辑器</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- 保留 dark-theme.css 引用 -->
    <link rel="stylesheet" href="css/dark-theme.css">
</head>

<body>

    <!-- 顶部导航 -->
    <nav class="top-nav">
        <div class="nav-brand">
            <svg class="icon" viewBox="0 0 24 24" style="color: var(--primary-color);">
                <path
                    d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-2h2v2zm0-4H7v-2h2v2zm0-4H7V7h2v2zm6 8H11v-2h4v2zm0-4H11v-2h4v2zm0-4H11V7h4v2z" />
            </svg>
            电子书编辑器
        </div>
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="basic">基础编辑</div>
            <div class="nav-tab" data-tab="advanced">高级设置</div>
            <div class="nav-tab" data-tab="smart">定时智能(开发中)</div>
        </div>
        <div class="nav-actions">
            <button id="theme-toggle-btn" class="btn btn-secondary btn-sm" title="切换主题">
                <svg class="icon" viewBox="0 0 24 24">
                    <path
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
            </button>
            <a href="index.html" class="btn btn-secondary btn-sm" target="_blank">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z" />
                </svg>
                播放测试
            </a>
            <button id="save-btn" class="btn btn-primary btn-sm">保存配置</button>
        </div>
    </nav>

    <!-- 主布局 -->
    <div class="app-container">

        <!-- 左侧边栏：页面列表 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span>页面列表</span>
                <span style="font-size: 0.8em; color: #999;" id="page-count-badge">0页</span>
            </div>
            <div class="sidebar-content" id="page-list">
                <!-- 动态生成的页面项 -->
            </div>
            <div class="sidebar-footer">
                <button id="add-page-btn" class="btn btn-secondary" style="width: 100%;"
                    onclick="document.getElementById('new-page-input').click()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                    </svg>
                    添加页面
                </button>
                <button id="batch-add-btn" class="btn btn-secondary" style="width: 100%; margin-top: 8px;"
                    title="选择多张图片，自动生成多个页面" onclick="document.getElementById('batch-image-input').click()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                    </svg>
                    批量导入页面
                </button>
                <div style="margin-top: 8px; display:flex; gap: 5px;">
                    <button id="remove-page-btn" class="btn btn-secondary btn-sm"
                        style="flex:1; color: var(--error-color);">删除</button>
                    <button class="btn btn-secondary btn-sm" style="flex:1;"
                        onclick="editor.editPageName(editor.currentPageId)">重命名</button>
                </div>
            </div>
        </aside>

        <!-- 右侧主内容 -->
        <main class="main-content" id="main-view">

            <!-- 工具栏 -->
            <div class="editor-toolbar">
                <div class="toolbar-group">
                    <h3 id="current-page-title" style="margin-right: 15px;">还没有选择页面</h3>
                    <!-- A4 方向切换 -->
                    <div class="btn-group">
                        <label class="btn btn-secondary btn-sm">
                            <input type="radio" name="orientation" value="portrait" id="portrait-mode" checked
                                style="display:none;">
                            <span onclick="document.getElementById('portrait-mode').click()">竖版 A4</span>
                        </label>
                        <label class="btn btn-secondary btn-sm">
                            <input type="radio" name="orientation" value="landscape" id="landscape-mode"
                                style="display:none;">
                            <span onclick="document.getElementById('landscape-mode').click()">横版 A4</span>
                        </label>
                    </div>
                </div>

                <div class="toolbar-group">
                    <button class="btn btn-secondary btn-sm"
                        onclick="document.getElementById('page-image-input').click()">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path
                                d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
                        </svg>
                        上传图片
                    </button>
                    <input type="file" id="page-image-input" accept="image/*" style="display: none;">

                    <button id="add-button-btn" class="btn btn-primary btn-sm">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z" />
                        </svg>
                        添加按钮
                    </button>
                </div>
            </div>

            <!-- 音频序列输入 -->
            <div style="width: 100%; max-width: 1000px; margin-bottom: 10px; padding: 0 5px;">
                <input type="text" id="audio-sequence" class="form-control" placeholder="音频序列 (例如: 0,1,2)">
            </div>

            <!-- 画布区域 -->
            <div class="canvas-wrapper">
                <div class="a4-canvas portrait" id="image-preview">
                    <div class="purple-frame"></div>
                    <img id="preview-img" class="canvas-image" alt="" style="display: none;">
                    <!-- 按钮容器 -->
                </div>
            </div>

            <!-- 底部面板：按钮管理 & 功能区 -->
            <div id="bottom-panel" class="panel" style="width: 100%; max-width: 1000px; margin-top: 20px;">
                <h3 class="panel-title">按钮管理</h3>
                <div class="button-list-container" id="button-list">
                    <!-- 按钮列表将在这里渲染 -->
                </div>
                <!-- 底部功能按钮 -->
                <div class="bottom-functions" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                    <div class="btn-group">
                        <button id="export-zip-btn" class="btn btn-primary" title="打包所有资源和配置 (.zip)">
                            📦 一键打包发布 (ZIP)
                        </button>
                        <button id="import-file-btn" class="btn btn-secondary btn-sm">导入JSON</button>
                        <button id="export-file-btn" class="btn btn-secondary btn-sm">仅导出JSON</button>
                        <button id="batch-audio-btn" class="btn btn-secondary btn-sm"
                            onclick="document.getElementById('audio-folder-input').click()">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path
                                    d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                            </svg>
                            批量导入音频
                        </button>
                        <button id="backup-btn" class="btn btn-secondary btn-sm">创建备份</button>
                        <button id="clear-buttons-btn" class="btn btn-secondary btn-sm"
                            style="color: var(--error-color);">清空按钮</button>
                    </div>
                </div>
            </div>

        </main>

        <!-- 高级设置标签页 -->
        <main class="main-content" id="advanced-view" style="display: none;">
            <div class="panel" style="width: 100%; max-width: 800px;">
                <h2 class="panel-title">JSON 配置</h2>
                <div class="form-group">
                    <textarea id="json-editor" class="form-control" rows="15" spellcheck="false"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="load-json-btn">从文本框加载</button>
                    <button class="btn btn-secondary" id="save-json-btn">刷新文本框</button>
                </div>

                <h2 class="panel-title" style="margin-top: 30px;">音频池</h2>
                <div class="form-group">
                    <textarea id="audio-pool" class="form-control" rows="10"></textarea>
                    <small>Audio Pool (Legacy ID: audio-pool)</small>
                </div>
                <div class="form-group">
                    <label>Base Path</label>
                    <input type="text" id="audio-base" class="form-control" value="audio/">
                </div>

                <!-- 隐藏的兼容性元素 -->
                <div style="display:none;">
                    <!-- 这些ID在 JS 中可能被引用，保留以防万一，虽然我会尽可能在 JS 中修复 -->
                    <button id="test-play-btn"></button>
                    <button id="reset-preview-btn"></button>
                    <button id="load-btn">Load</button>
                    <button id="export-btn">Export</button>
                    <div id="live-preview"></div>
                    <input id="override-audio">
                    <input id="button-pos">
                    <input id="button-x">
                    <input id="button-y">
                    <div id="advanced-content"></div>
                    <div id="advanced-toggle"></div>
                </div>
            </div>
        </main>

    </div>

    <!-- 按钮编辑弹窗 -->
    <div id="button-edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑按钮 <span id="edit-button-number"></span></h3>
                <button class="close-btn" id="close-edit-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">音频索引 (Pos)</label>
                    <input type="number" id="modal-button-pos" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">覆盖音频文件 (可选)</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="modal-override-audio" class="form-control" placeholder="自定义文件名">
                        <button id="modal-browse-audio-btn" class="btn btn-secondary">浏览...</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">位置微调 (X, Y)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="modal-button-x" class="form-control" step="0.01">
                        <input type="number" id="modal-button-y" class="form-control" step="0.01">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-edit-modal">取消</button>
                <button class="btn btn-primary" id="save-edit-modal">保存</button>
                <!-- 隐藏的旧 ID 以防 JS 报错 -->
                <div id="error-message" style="display:none"></div>
                <div id="status-message" style="display:none"></div>
            </div>
        </div>
    </div>

    <!-- 状态通知 Toast -->
    <div id="status-toast"
        style="position: fixed; top: 70px; right: 20px; background: #333; color: #fff; padding: 10px 20px; border-radius: 4px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 2000;">
        状态消息
    </div>

    <!-- 依赖脚本 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Hidden Inputs -->
    <input type="file" id="batch-image-input" accept="image/*" multiple style="display:none">
    <input type="file" id="new-page-input" accept="image/*" style="display:none">
    <input type="file" id="audio-folder-input" webkitdirectory directory multiple accept="audio/*" style="display:none">

    <script src="js/player.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/tauri-adapter.js"></script>
    <script>
        // 初始化全局变量 editor
        const editor = new BookEditor();
    </script>
</body>

</html>