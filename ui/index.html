<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="äº’åŠ¨ç‚¹è¯»ç”µå­ä¹¦æ’­æ”¾å™¨ - ç‚¹å‡»é¡µé¢æŒ‰é’®æ’­æ”¾éŸ³é¢‘å†…å®¹">
    <title>äº’åŠ¨ç‚¹è¯»ç”µå­ä¹¦</title>

    <!-- å¤–éƒ¨æ ·å¼è¡¨ -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dark-theme.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f0f0f0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-text {
            flex: 1;
            text-align: left;
        }

        .header-actions {
            margin-left: 20px;
        }

        .edit-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .edit-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .edit-btn svg {
            width: 16px;
            height: 16px;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .book-view {
            flex: 1;
            position: relative;
            background: white;
            margin: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .page-image-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* A4æ¯”ä¾‹è™šçº¿æ¡†æ ·å¼ */
        .a4-outline {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            pointer-events: none;
        }

        .a4-border {
            border: 2px dashed rgba(106, 17, 203, 0.5);
            background: rgba(106, 17, 203, 0.05);
            box-sizing: border-box;
        }

        .a4-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(106, 17, 203, 0.8);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        /* å¸ƒå±€è°ƒæ•´ï¼šç¡®ä¿æŒ‰é’®å’Œå›¾ç‰‡ä½¿ç”¨ç›¸åŒçš„åæ ‡ç³» */
        .page-image-container {
            flex: 1;
            position: relative;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 20px;
        }

        /* æ ¸å¿ƒåŒ…è£…å™¨ï¼šç»´æŒ A4 æ¯”ä¾‹ */
        .page-content-wrapper {
            position: relative;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);

            /* é»˜è®¤ç«–ç‰ˆ A4 (595/842 = 0.706..) */
            aspect-ratio: 595 / 842;

            /* è‡ªé€‚åº”é€»è¾‘ï¼šåœ¨å®¹å™¨å†…å°½å¯èƒ½å¤§ï¼Œä½†ä¸æº¢å‡º */
            height: 100%;
            width: auto;
            max-width: 100%;
        }

        /* æ¨ªç‰ˆ A4 */
        .page-content-wrapper.landscape {
            aspect-ratio: 842 / 595;
            width: 100%;
            height: auto;
            max-height: 100%;
        }

        /* ç§»åŠ¨ç«¯ç«–å±é€‚é…ï¼šå¦‚æœå±å¹•å¾ˆçª„ï¼Œè®©å®ƒæ’‘æ»¡å®½åº¦ */
        @media (max-width: 600px) {
            .page-content-wrapper {
                width: 100% !important;
                height: auto !important;
            }
        }

        #page-image {
            width: 100%;
            height: 100%;
            object-fit: fill;
            /* Wrapper å·²ç»æ§åˆ¶äº†æ¯”ä¾‹ */
            display: none;
            /* JS ä¼šæ§åˆ¶æ˜¾ç¤º */
            z-index: 1;
        }

        .button-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        /* æŒ‰é’®åŒºåŸŸ */
        .page-button {
            pointer-events: auto;
            position: absolute;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            /* ç»ç’ƒæ‹Ÿæ€èƒŒæ™¯ */
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        /* å†…éƒ¨æ ¸å¿ƒæ’­æ”¾å›¾æ ‡ */
        .page-button::after {
            content: '';
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 0 8px 14px;
            border-color: transparent transparent transparent white;
            margin-left: 4px;
            /* è§†è§‰å±…ä¸­æ ¡æ­£ */
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            transition: all 0.3s ease;
        }

        /* ä»ç„¶ä¿ç•™æ•°å­—ï¼Œä½†åšå¾—å¾ˆå°å¾ˆç²¾è‡´ï¼Œæ”¾åœ¨å³ä¸‹è§’æˆ–è€… hover æ˜¾ç¤º */
        .page-button span {
            position: absolute;
            bottom: -20px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            white-space: nowrap;
        }

        .page-button:hover span {
            opacity: 1;
        }

        /* æ‚¬åœæ•ˆæœ */
        .page-button:hover {
            transform: translate(-50%, -50%) scale(1.15);
            background: rgba(255, 255, 255, 0.4);
            border-color: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        /* å‘¼å¸åŠ¨ç”» (æ¶Ÿæ¼ª) */
        .page-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            opacity: 0;
            animation: ripple 2s infinite;
            z-index: -1;
        }

        @keyframes ripple {
            0% {
                width: 100%;
                height: 100%;
                opacity: 0.8;
                border-width: 2px;
            }

            100% {
                width: 200%;
                height: 200%;
                opacity: 0;
                border-width: 0;
            }
        }

        /* æ¿€æ´»çŠ¶æ€ */
        .page-button.active {
            background: linear-gradient(135deg, #ff9800, #ff5722) !important;
            border-color: #ffcc80 !important;
            animation: pulse-active 1.5s infinite;
        }

        .page-button.active::after {
            border-color: transparent transparent transparent rgba(255, 255, 255, 0.9);
        }

        @keyframes pulse-active {
            0% {
                transform: translate(-50%, -50%) scale(1.1);
                box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.7);
            }

            70% {
                transform: translate(-50%, -50%) scale(1.15);
                box-shadow: 0 0 0 20px rgba(255, 87, 34, 0);
            }

            100% {
                transform: translate(-50%, -50%) scale(1.1);
                box-shadow: 0 0 0 0 rgba(255, 87, 34, 0);
            }
        }

        .controls {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(106, 17, 203, 0.3);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e8e8e8;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }

        .status-bar {
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 0.9rem;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
        }

        .status-indicator.playing {
            background: #ff9800;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6a11cb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-message {
            color: #ff4444;
            text-align: center;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            margin: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .page-indicator {
            font-size: 0.9rem;
            color: #666;
            background: #f5f5f5;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
        }

        /* iPad ä¼˜åŒ– */
        @media (max-width: 1024px) {
            .header h1 {
                font-size: 1.3rem;
            }

            .btn {
                padding: 14px 16px;
                font-size: 0.95rem;
            }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .nav-buttons {
                width: 100%;
            }

            .status-bar {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            animation: fadeIn 0.3s ease;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-circle);
            transition: all var(--transition-normal);
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-content">
            <div class="header-text">
                <h1>äº’åŠ¨ç‚¹è¯»ç”µå­ä¹¦</h1>
                <div class="subtitle">ç‚¹å‡»é¡µé¢ä¸Šçš„æŒ‰é’®æ’­æ”¾éŸ³é¢‘/è§†é¢‘</div>
            </div>
            <div class="header-actions">
                <button id="open-config-btn" class="edit-btn" title="æ‰“å¼€é…ç½®æ–‡ä»¶ (Open book.json)"
                    style="border: none; cursor: pointer;">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z" />
                    </svg>
                    æ‰“å¼€ä¹¦
                </button>
                <input type="file" id="config-upload-input" accept=".json,.zip" style="display: none;">

                <button id="theme-toggle-btn" class="edit-btn" title="åˆ‡æ¢æ˜æš—ä¸»é¢˜ (T)"
                    style="border: none; cursor: pointer; margin-left: 8px;">
                    <svg id="theme-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <span id="theme-text">æ·±è‰²</span>
                </button>
                <button id="help-btn" class="edit-btn" title="å¿«æ·é”®å¸®åŠ© (?)"
                    style="border: none; cursor: pointer; margin-left: 8px;">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z" />
                    </svg>
                    å¸®åŠ©
                </button>

                <button id="reading-mode-btn" class="edit-btn" title="é˜…è¯»æ¨¡å¼ (ESCé€€å‡º)" style="margin-left: 8px;">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                    </svg>
                    é˜…è¯»æ¨¡å¼
                </button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="book-view">
            <div class="page-image-container">
                <div id="page-content-wrapper" class="page-content-wrapper">
                    <img id="page-image" alt="å½“å‰é¡µé¢">
                    <div class="button-area" id="button-area"></div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>æ­£åœ¨åŠ è½½ç”µå­ä¹¦...</div>
            </div>
        </div>

        <div class="controls">
            <div class="nav-buttons">
                <button id="prev-btn" class="btn btn-secondary">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z" />
                    </svg>
                    ä¸Šä¸€é¡µ
                </button>
                <button id="auto-play-btn" class="btn btn-secondary" title="è‡ªåŠ¨æœ—è¯»å½“å‰é¡µå¹¶ç¿»é¡µ">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                    è‡ªåŠ¨æœ—è¯»
                </button>
                <button id="next-btn" class="btn btn-primary">
                    ä¸‹ä¸€é¡µ
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <div class="status-indicator" id="status-indicator"></div>
            <span id="status-text">å‡†å¤‡å°±ç»ª</span>
        </div>
        <div class="page-indicator">
            é¡µé¢: <span id="current-page-display">-</span> / <span id="total-pages-display">-</span>
        </div>
    </div>

    <!-- å¿«æ·é”®å¸®åŠ©æ¨¡æ€æ¡† -->
    <div id="help-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>âŒ¨ï¸ é”®ç›˜å¿«æ·é”®</h3>
                <button class="modal-close" id="close-help-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 150px 1fr; gap: 12px; font-size: 0.9rem;">
                    <div style="font-weight: 600;">â† â†’</div>
                    <div>ä¸Šä¸€é¡µ / ä¸‹ä¸€é¡µ</div>

                    <div style="font-weight: 600;">ç©ºæ ¼</div>
                    <div>æš‚åœ / ç»§ç»­æ’­æ”¾</div>

                    <div style="font-weight: 600;">T</div>
                    <div>åˆ‡æ¢æ˜æš—ä¸»é¢˜</div>

                    <div style="font-weight: 600;">F</div>
                    <div>å…¨å±æ’­æ”¾</div>



                    <div style="font-weight: 600;">?</div>
                    <div>æ˜¾ç¤º/éšè—æ­¤å¸®åŠ©</div>

                    <div style="font-weight: 600;">ESC</div>
                    <div>é€€å‡ºå…¨å± / å…³é—­å¸®åŠ©</div>
                </div>

                <div
                    style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-light); color: var(--text-secondary); font-size: 0.85rem;">
                    <p>ğŸ’¡ æç¤º:ç‚¹å‡»é¡µé¢ä¸Šçš„æŒ‰é’®æ’­æ”¾å¯¹åº”çš„éŸ³é¢‘å†…å®¹</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="got-it-btn">çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <script src="js/theme-manager.js"></script>
    <script src="js/player.js"></script>
    <script>
        // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
        const themeManager = new ThemeManager();

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');

        function updateThemeButton() {
            const currentTheme = themeManager.getCurrentTheme();
            if (currentTheme === 'dark') {
                themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
                themeText.textContent = 'æµ…è‰²';
            } else {
                themeIcon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
                themeText.textContent = 'æ·±è‰²';
            }
        }

        themeToggleBtn.addEventListener('click', () => {
            themeManager.toggleTheme();
            themeManager.markManualTheme();
            updateThemeButton();
        });

        updateThemeButton();

        // å¸®åŠ©æ¨¡æ€æ¡†åŠŸèƒ½
        const helpModal = document.getElementById('help-modal');
        const helpBtn = document.getElementById('help-btn');
        const closeHelpBtn = document.getElementById('close-help-modal');
        const gotItBtn = document.getElementById('got-it-btn');

        function showHelpModal() {
            helpModal.style.display = 'flex';
        }

        function hideHelpModal() {
            helpModal.style.display = 'none';
        }

        helpBtn.addEventListener('click', showHelpModal);
        closeHelpBtn.addEventListener('click', hideHelpModal);
        gotItBtn.addEventListener('click', hideHelpModal);

        // é˜…è¯»æ¨¡å¼åŠŸèƒ½
        const readingModeBtn = document.getElementById('reading-mode-btn');

        function toggleReadingMode() {
            document.body.classList.toggle('reading-mode');

            // æç¤ºç”¨æˆ·å¦‚ä½•é€€å‡º
            if (document.body.classList.contains('reading-mode')) {
                showToast('æŒ‰ ESC é”®é€€å‡ºé˜…è¯»æ¨¡å¼');
            }
        }

        function exitReadingMode() {
            document.body.classList.remove('reading-mode');
        }

        readingModeBtn.addEventListener('click', toggleReadingMode);

        // ESC é”®é€€å‡ºé˜…è¯»æ¨¡å¼
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.body.classList.contains('reading-mode')) {
                exitReadingMode();
            }
        });

        // ç®€å•çš„ Toast æç¤º
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);

            // åŠ¨ç”»
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // é…ç½®æ–‡ä»¶ä¸Šä¼ åŠ è½½åŠŸèƒ½
        const openConfigBtn = document.getElementById('open-config-btn');
        const configUploadInput = document.getElementById('config-upload-input');

        openConfigBtn.addEventListener('click', () => {
            configUploadInput.click();
        });

        async function handleConfigLoad(file) {
            if (!file) return;

            // æ ¼å¼æ£€æŸ¥
            if (!file.name.endsWith('.json') && !file.name.endsWith('.zip')) {
                alert('è¯·é€‰æ‹© .json æˆ– .zip æ ¼å¼çš„æ–‡ä»¶');
                return;
            }

            // å¤„ç† ZIP
            if (file.name.endsWith('.zip')) {
                if (typeof JSZip === 'undefined') {
                    alert('JSZip åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢');
                    return;
                }

                const loading = document.getElementById('loading');
                if (loading) {
                    loading.style.display = 'flex';
                    loading.querySelector('div:last-child').textContent = 'æ­£åœ¨è§£å‹èµ„æº...';
                }

                try {
                    const zip = await new JSZip().loadAsync(file);

                    // 1. è¯»å– book.json
                    const configCtx = await zip.file("book.json").async("text");
                    const config = JSON.parse(configCtx);

                    if (!config.pages) throw new Error('æ— æ•ˆçš„é…ç½®æ–‡ä»¶ï¼šç¼ºå°‘ pages å­—æ®µ');

                    // 2. å¤„ç†èµ„æº (Images & Audio) -> Blob URLs
                    const assetMap = new Map(); // path -> blobUrl
                    const entries = [];
                    zip.forEach((relativePath, zipEntry) => {
                        if (!zipEntry.dir) entries.push({ path: relativePath, entry: zipEntry });
                    });

                    // å¹¶è¡Œè§£å‹
                    await Promise.all(entries.map(async (item) => {
                        const blob = await item.entry.async("blob");
                        const blobUrl = URL.createObjectURL(blob);
                        assetMap.set(item.path, blobUrl);
                    }));

                    // 3. æ›´æ–° Config ä¸­çš„ Image å¼•ç”¨
                    Object.keys(config.pages).forEach(pageId => {
                        const page = config.pages[pageId];
                        // å°è¯•åŒ¹é… images/filename
                        if (page.image && assetMap.has(page.image)) {
                            page.image = assetMap.get(page.image);
                        } else {
                            // å°è¯•æ¨¡ç³ŠåŒ¹é…ï¼Œé˜²æ­¢è·¯å¾„åˆ†éš”ç¬¦é—®é¢˜
                            // (æš‚ä¸å¤„ç†ï¼Œå‡è®¾ zip ç»“æ„æ ‡å‡†)
                        }
                    });

                    // 4. æ›´æ–° Player çš„ Audio Cache
                    // Player é»˜è®¤æ‹¼æ¥ï¼šaudioBase + filename
                    // æˆ‘ä»¬æŠŠ assetMap ä¸­çš„æ‰€æœ‰ asset éƒ½å¡ç»™ player cache
                    // è¿™æ · player.playMedia(src) æŸ¥ existing cache æ—¶å°±èƒ½æ‰¾åˆ°
                    if (window.player) {
                        // æ¸…ç†æ—§ç¼“å­˜ (å¦‚æœéœ€è¦? ç¨å¾®æ¿€è¿›ï¼Œä½† ZIP æ˜¯ä¸€æ¬¡æ€§åŠ è½½)
                        // window.player.audioCache.clear(); 
                        // æš‚æ—¶ä¸ clearï¼Œå…è®¸æ··åˆä½¿ç”¨
                        assetMap.forEach((url, path) => {
                            window.player.audioCache.set(path, url);
                        });
                    }

                    // 5. åŠ è½½ Config
                    loadConfigToPlayer(config, file.name);

                } catch (err) {
                    alert('æ— æ³•è¯»å– ZIP æ–‡ä»¶: ' + err.message);
                    console.error(err);
                } finally {
                    if (loading) loading.style.display = 'none';
                }
                return;
            }

            // å¤„ç† JSON (åŸæœ‰é€»è¾‘)
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    loadConfigToPlayer(config, file.name);
                } catch (err) {
                    alert('æ— æ³•åŠ è½½é…ç½®æ–‡ä»¶: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function loadConfigToPlayer(config, fileName) {
            // éªŒè¯åŸºæœ¬ç»“æ„
            if (!config.pages) {
                throw new Error('æ— æ•ˆçš„é…ç½®æ–‡ä»¶ï¼šç¼ºå°‘ pages å­—æ®µ');
            }

            if (window.player) {
                window.player.stop(); // åœæ­¢å½“å‰æ’­æ”¾
                window.player.book = config;
                // é‡æ–°åˆå§‹åŒ–é¡µé¢åˆ—è¡¨
                const pageIds = window.player.getPageIds();
                const totalPagesDisplay = document.getElementById('total-pages-display');
                const statusText = document.getElementById('status-text');

                if (totalPagesDisplay) totalPagesDisplay.textContent = pageIds.length;

                // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
                const event = new CustomEvent('book-loaded', { detail: config });
                document.dispatchEvent(event);

                if (statusText) statusText.textContent = `å·²åŠ è½½: ${fileName}`;
            }
        }

        configUploadInput.addEventListener('change', (e) => {
            handleConfigLoad(e.target.files[0]);
        });

        // æ‹–æ‹½æ”¯æŒ
        document.body.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            document.body.style.boxShadow = 'inset 0 0 50px rgba(106, 17, 203, 0.2)';
        });

        document.body.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            document.body.style.boxShadow = 'none';
        });

        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            document.body.style.boxShadow = 'none';

            const files = e.dataTransfer.files;
            if (files && files.length > 0) {
                handleConfigLoad(files[0]);
            }
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                hideHelpModal();
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            // Auto-enable Reading Mode for clean UI
            document.body.classList.add('reading-mode');

            const player = new InteractiveBookPlayer('book.json');
            window.player = player;
            const loading = document.getElementById('loading');
            const pageImage = document.getElementById('page-image');
            const buttonArea = document.getElementById('button-area');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const currentPageDisplay = document.getElementById('current-page-display');
            const totalPagesDisplay = document.getElementById('total-pages-display');

            let pageIds = [];
            let currentPageIndex = 0;

            // ç›‘å¬å¤–éƒ¨é…ç½®åŠ è½½
            document.addEventListener('book-loaded', (e) => {
                const config = e.detail;
                player.book = config;
                pageIds = player.getPageIds();
                totalPagesDisplay.textContent = pageIds.length;
                // åœæ­¢è‡ªåŠ¨æ’­æ”¾
                if (typeof stopAutoPlay === 'function') stopAutoPlay();

                if (pageIds.length > 0) {
                    showPage(0);
                } else {
                    alert('è¯¥é…ç½®æ–‡ä»¶æ²¡æœ‰é¡µé¢ï¼');
                }
                console.log('External config loaded:', config);
            });

            try {
                // åŠ è½½ä¹¦ç±é…ç½®
                await player.load();
                pageIds = player.getPageIds();

                if (pageIds.length === 0) {
                    throw new Error('ä¹¦ç±ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é¡µé¢');
                }

                // æ›´æ–°é¡µé¢è®¡æ•°æ˜¾ç¤º
                totalPagesDisplay.textContent = pageIds.length;

                // æ˜¾ç¤ºç¬¬ä¸€é¡µ
                showPage(0);

                // é»˜è®¤è‡ªåŠ¨å¼€å¯é˜…è¯»æ¨¡å¼
                // å»¶è¿Ÿä¸€ç‚¹ä»¥ç¡®ä¿æ¸²æŸ“å°±ç»ª
                setTimeout(() => {
                    if (!document.body.classList.contains('reading-mode')) {
                        toggleReadingMode();
                    }
                }, 500);

                // éšè—åŠ è½½ç•Œé¢
                loading.style.display = 'none';

            } catch (error) {
                loading.innerHTML = `
                    <div class="error-message">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p style="margin: 10px 0; color: #666; font-size: 0.9rem;">${error.message}</p>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                            <button onclick="location.reload()" class="btn btn-primary">
                                é‡è¯•
                            </button>
                            <label class="btn btn-secondary" style="cursor: pointer;">
                                ğŸ“‚ æ‰“å¼€æœ¬ä¹¦ (.zip / .json)
                                <input type="file" id="manual-load-input" accept=".json,.zip" style="display: none;">
                            </label>
                        </div>
                    </div>
                `;

                // ç»‘å®šæ‰‹åŠ¨åŠ è½½äº‹ä»¶
                const manualInput = document.getElementById('manual-load-input');
                if (manualInput) {
                    manualInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        try {
                            // Check for ZIP
                            if (file.name.toLowerCase().endsWith('.zip')) {
                                loading.innerHTML = '<div class="loading-spinner"></div><p>æ­£åœ¨è§£å‹èµ„æº...</p>';
                                loading.style.display = 'flex';

                                const zip = new JSZip();
                                const contents = await zip.loadAsync(file);

                                // 1. Find and Parse book.json
                                const bookFile = Object.values(contents.files).find(f => f.name.match(/book\.json$/i));
                                if (!bookFile) throw new Error('å‹ç¼©åŒ…å†…æ‰¾ä¸åˆ° book.json');

                                const bookText = await bookFile.async('string');
                                const config = JSON.parse(bookText);

                                // 2. Process Assets
                                const imagePromises = [];
                                const audioPromises = [];

                                // Helper to match zip file
                                const findFile = (path) => {
                                    // Try exact match first
                                    let f = contents.file(path);
                                    if (f) return f;
                                    // Try with/without leading slash or folder prefix
                                    const name = path.split('/').pop();
                                    // Search in all files
                                    return Object.values(contents.files).find(f => f.name.endsWith(name));
                                };

                                // Process Images (Replace paths with Blob URLs)
                                for (const pageId in config.pages) {
                                    const page = config.pages[pageId];
                                    if (page.image) {
                                        const zipFile = findFile(page.image);
                                        if (zipFile) {
                                            const blob = await zipFile.async('blob');
                                            page.image = URL.createObjectURL(blob);
                                        }
                                    }
                                }

                                // Process Audio (Populate Player Cache)
                                const processAudio = async (path) => {
                                    if (!path) return;
                                    const zipFile = findFile(path);
                                    if (zipFile) {
                                        const blob = await zipFile.async('blob');
                                        const url = URL.createObjectURL(blob);
                                        // Cache with the original path key so player finds it
                                        // Handle potential base path
                                        let base = config.audioBase || 'audio/';
                                        if (!base.endsWith('/')) base += '/';

                                        // If path is just filename, prepend base
                                        const fullPath = path.startsWith(base) ? path : base + path;

                                        // We cache both to be safe
                                        player.audioCache.set(path, url);
                                        player.audioCache.set(fullPath, url);
                                        // Remove base for bare filename match
                                        player.audioCache.set(path.split('/').pop(), url);
                                    }
                                };

                                // Walk through audio references
                                if (config.audioPool) {
                                    for (const audio of config.audioPool) {
                                        await processAudio(audio);
                                    }
                                }
                                for (const pageId in config.pages) {
                                    const page = config.pages[pageId];
                                    if (page.buttons) {
                                        for (const btn of page.buttons) {
                                            if (btn.override) await processAudio(btn.override);
                                        }
                                    }
                                }

                                // Apply Config
                                player.book = config;
                                pageIds = player.getPageIds();
                                totalPagesDisplay.textContent = pageIds.length;
                                showPage(0);
                                loading.style.display = 'none';
                                console.log('Loaded ZIP project:', config);

                            } else {
                                // JSON Load (Legacy)
                                const reader = new FileReader();
                                reader.onload = async (event) => {
                                    try {
                                        const config = JSON.parse(event.target.result);
                                        player.book = config;
                                        pageIds = player.getPageIds();
                                        totalPagesDisplay.textContent = pageIds.length;
                                        showPage(0);
                                        loading.style.display = 'none';
                                        console.log('Manually loaded config:', config);
                                    } catch (err) {
                                        alert('è§£æ JSON å¤±è´¥: ' + err.message);
                                    }
                                };
                                reader.readAsText(file);
                            }

                        } catch (err) {
                            console.error(err);
                            alert('è¯»å–å¤±è´¥: ' + err.message);
                            loading.style.display = 'flex'; // Show error state again if needed or reset
                        }
                    });
                }
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            }

            function showPage(index) {
                if (index < 0 || index >= pageIds.length) return;

                currentPageIndex = index;
                const pageId = pageIds[index];

                // æ˜¾ç¤ºé¡µé¢
                player.showPage(pageId);

                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                currentPageDisplay.textContent = index + 1;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                prevBtn.disabled = index === 0;
                nextBtn.disabled = index === pageIds.length - 1;

                // æ›´æ–°çŠ¶æ€
                updateStatus('é¡µé¢åŠ è½½å®Œæˆ');

                // é¢„åŠ è½½ç›¸é‚»é¡µé¢çš„éŸ³é¢‘ï¼ˆåå°å¼‚æ­¥ï¼‰
                setTimeout(() => {
                    player.preloadAdjacentPages(index, pageIds);
                }, 100);
            }

            function updateStatus(message, isPlaying = false) {
                statusText.textContent = message;
                if (isPlaying) {
                    statusIndicator.className = 'status-indicator playing';
                } else {
                    statusIndicator.className = 'status-indicator';
                }
            }

            // ç›‘å¬æ’­æ”¾çŠ¶æ€å˜åŒ–
            setInterval(() => {
                if (player.isPlaying) {
                    updateStatus('æ­£åœ¨æ’­æ”¾...', true);
                } else if (statusText.textContent === 'æ­£åœ¨æ’­æ”¾...') {
                    updateStatus('é¡µé¢åŠ è½½å®Œæˆ', false);
                }
            }, 500);

            const autoPlayBtn = document.getElementById('auto-play-btn');

            let isAutoPlaying = false;

            // åœæ­¢è‡ªåŠ¨æ’­æ”¾è¾…åŠ©å‡½æ•°
            function stopAutoPlay() {
                if (!isAutoPlaying) return;
                isAutoPlaying = false;
                // æ¢å¤UIçŠ¶æ€
                autoPlayBtn.innerHTML = `
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                         <path d="M8 5v14l11-7z"/>
                    </svg>
                    è‡ªåŠ¨æœ—è¯»`;
                autoPlayBtn.classList.remove('btn-primary');
                autoPlayBtn.classList.add('btn-secondary');
                player.stop();
            }

            // è‡ªåŠ¨æ’­æ”¾æŒ‰é’®é€»è¾‘
            if (autoPlayBtn) {
                autoPlayBtn.addEventListener('click', async () => {
                    if (isAutoPlaying) {
                        stopAutoPlay();
                        return;
                    }

                    // å¼€å§‹è‡ªåŠ¨æ’­æ”¾
                    isAutoPlaying = true;
                    autoPlayBtn.innerHTML = `
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 6h12v12H6z"/>
                        </svg>
                        åœæ­¢æœ—è¯»`;
                    autoPlayBtn.classList.remove('btn-secondary');
                    autoPlayBtn.classList.add('btn-primary');

                    // æ’­æ”¾å¾ªç¯
                    while (isAutoPlaying) {
                        try {
                            updateStatus('æ­£åœ¨è‡ªåŠ¨æœ—è¯»...', true);
                            await player.playPageSequence();

                            if (!isAutoPlaying) break; // ä¸­é€”åœæ­¢

                            // è¯»å®Œå½“å‰é¡µï¼Œç­‰å¾…ä¸€å°ä¼šå„¿
                            await new Promise(r => setTimeout(r, 1000));

                            if (!isAutoPlaying) break;

                            // ç¿»é¡µ
                            if (currentPageIndex < pageIds.length - 1) {
                                nextBtn.click(); // æ­¤æ“ä½œä¼šè§¦å‘ showPage -> åˆå§‹åŒ–æ–°é¡µé¢
                                // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆï¼ˆç®€å•å»¶æ—¶ï¼Œæˆ–è€…ä¾èµ– showPage çš„åŒæ­¥æ€§ï¼‰
                                await new Promise(r => setTimeout(r, 1000));
                            } else {
                                stopAutoPlay();
                                alert('å·²è¯»å®Œæœ€åä¸€é¡µ');
                                break;
                            }
                        } catch (e) {
                            console.error('Auto play error:', e);
                            stopAutoPlay();
                            break;
                        }
                    }
                });
            }

            // æŒ‰é’®äº‹ä»¶
            prevBtn.addEventListener('click', () => {
                stopAutoPlay(); // æ‰‹åŠ¨æ“ä½œåœæ­¢è‡ªåŠ¨æ’­æ”¾
                showPage(currentPageIndex - 1);
            });

            nextBtn.addEventListener('click', () => {
                stopAutoPlay(); // æ‰‹åŠ¨æ“ä½œåœæ­¢è‡ªåŠ¨æ’­æ”¾
                showPage(currentPageIndex + 1);
            });

            // é”®ç›˜å¯¼èˆªæ”¯æŒ - å¢å¼ºç‰ˆ
            document.addEventListener('keydown', (e) => {
                // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†ä¸­ï¼Œä¸è§¦å‘å¿«æ·é”®
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch (e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        prevBtn.click();
                        break;

                    case 'ArrowRight':
                        e.preventDefault();
                        nextBtn.click();
                        break;

                    case ' ':
                        e.preventDefault();
                        // ç©ºæ ¼é”®æš‚åœ/æ’­æ”¾ï¼ˆå¦‚æœæœ‰å½“å‰æ’­æ”¾çš„åª’ä½“ï¼‰
                        if (player.audioElement) {
                            if (player.audioElement.paused) {
                                player.audioElement.play();
                            } else {
                                player.audioElement.pause();
                            }
                        }
                        break;

                    case 't':
                    case 'T':
                        e.preventDefault();
                        themeToggleBtn.click();
                        break;

                    case 'f':
                    case 'F':
                        e.preventDefault();
                        // å…¨å±åˆ‡æ¢
                        if (!document.fullscreenElement) {
                            document.documentElement.requestFullscreen().catch(err => {
                                console.warn('æ— æ³•è¿›å…¥å…¨å±:', err);
                            });
                        } else {
                            document.exitFullscreen();
                        }
                        break;



                    case '?':
                        e.preventDefault();
                        if (helpModal.style.display === 'none') {
                            showHelpModal();
                        } else {
                            hideHelpModal();
                        }
                        break;

                    case 'Escape':
                        if (helpModal.style.display !== 'none') {
                            hideHelpModal();
                        } else if (document.body.classList.contains('reading-mode')) {
                            // ä¼˜å…ˆé€€å‡ºé˜…è¯»æ¨¡å¼
                            exitReadingMode();
                        } else if (document.fullscreenElement) {
                            document.exitFullscreen();
                        }
                        break;
                }
            });

            // è§¦æ‘¸æ»‘åŠ¨æ”¯æŒ (Swipe Support)
            let touchStartX = 0;
            let touchEndX = 0;
            const minSwipeDistance = 50; // æœ€å°æ»‘åŠ¨è·ç¦»

            document.body.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            document.body.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                const distance = touchEndX - touchStartX;

                // ç¡®ä¿æ»‘åŠ¨è·ç¦»è¶³å¤Ÿ
                if (Math.abs(distance) < minSwipeDistance) return;

                if (distance > 0) {
                    // å‘å³æ»‘åŠ¨ -> ä¸Šä¸€é¡µ
                    if (!prevBtn.disabled) {
                        prevBtn.click();
                    }
                } else {
                    // å‘å·¦æ»‘åŠ¨ -> ä¸‹ä¸€é¡µ
                    if (!nextBtn.disabled) {
                        nextBtn.click();
                    }
                }
            }

            // ç‚¹å‡»ç¿»é¡µæ”¯æŒ (Click Navigation for Reading Mode)
            // å·¦è¾¹ 30% -> ä¸Šä¸€é¡µ
            // å³è¾¹ 30% -> ä¸‹ä¸€é¡µ
            // ä¸­é—´ -> æ˜¾ç¤º/éšè—å¸®åŠ©æˆ–ä¸åšå¤„ç† (æ ¹æ® "No other buttons" éœ€æ±‚ï¼Œæš‚ä¸å¤„ç†ä¸­é—´ï¼Œæˆ–è€…ä¸­é—´å¯ä»¥ç”¨æ¥æ˜¾ç¤º Toast)
            document.body.addEventListener('click', (e) => {
                // ä»…åœ¨é˜…è¯»æ¨¡å¼ä¸‹ç”Ÿæ•ˆ
                if (!document.body.classList.contains('reading-mode')) return;

                // å¿½ç•¥ç‰¹å®šçš„äº¤äº’å…ƒç´ 
                if (e.target.closest('.page-button') ||
                    e.target.closest('.controls') || // ç†è®ºä¸Š hidden
                    e.target.closest('.modal') ||
                    e.target.id === 'reading-mode-btn') {
                    return;
                }

                const width = window.innerWidth;
                const x = e.clientX;

                // å·¦ä¾§ 30%
                if (x < width * 0.3) {
                    if (!prevBtn.disabled) {
                        prevBtn.click();
                        // åé¦ˆ
                        showToast('ä¸Šä¸€é¡µ');
                    }
                }
                // å³ä¾§ 30%
                else if (x > width * 0.7) {
                    if (!nextBtn.disabled) {
                        nextBtn.click();
                        // åé¦ˆ
                        showToast('ä¸‹ä¸€é¡µ');
                    }
                }
            });

            // å¯¼å‡ºåˆ°å…¨å±€ä»¥ä¾¿è°ƒè¯•
            window.player = player;
            window.showPage = showPage;

            // ==========================================
            // New: Auto-Load ZIP from URL
            // ==========================================
            async function loadFromZipBlob(blob) {
                try {
                    loading.innerHTML = '<div class="loading-spinner"></div><p>æ­£åœ¨è¯»å–èµ„æºåŒ…...</p>';
                    loading.style.display = 'flex';

                    const zip = new JSZip();
                    const contents = await zip.loadAsync(blob);

                    // 1. Find book.json
                    const bookFile = Object.values(contents.files).find(f => f.name.match(/book\.json$/i));
                    if (!bookFile) throw new Error('å‹ç¼©åŒ…å†…æ‰¾ä¸åˆ° book.json');

                    const bookText = await bookFile.async('string');
                    const config = JSON.parse(bookText);

                    // 2. Process Assets
                    const findFile = (path) => {
                        if (!path) return null;
                        let f = contents.file(path);
                        if (f) return f;
                        const name = path.split('/').pop();
                        return Object.values(contents.files).find(f => f.name.endsWith(name));
                    };

                    // Images
                    for (const pageId in config.pages) {
                        const page = config.pages[pageId];
                        if (page.image) {
                            const zipFile = findFile(page.image);
                            if (zipFile) {
                                const b = await zipFile.async('blob');
                                page.image = URL.createObjectURL(b);
                            }
                        }
                    }

                    // Audio
                    const processAudio = async (path) => {
                        if (!path) return;
                        const zipFile = findFile(path);
                        if (zipFile) {
                            const b = await zipFile.async('blob');
                            const url = URL.createObjectURL(b);
                            // Cache
                            let base = config.audioBase || 'audio/';
                            if (!base.endsWith('/')) base += '/';

                            const fullPath = path.startsWith(base) ? path : base + path;

                            player.audioCache.set(path, url);
                            player.audioCache.set(fullPath, url);
                            player.audioCache.set(path.split('/').pop(), url);
                        }
                    };

                    if (config.audioPool) {
                        for (const a of config.audioPool) await processAudio(a);
                    }
                    for (const pageId in config.pages) {
                        const p = config.pages[pageId];
                        if (p.buttons) {
                            for (const btn of p.buttons) if (btn.override) await processAudio(btn.override);
                        }
                    }

                    player.book = config;
                    pageIds = player.getPageIds();
                    // Update UI
                    if (typeof totalPagesDisplay !== 'undefined') totalPagesDisplay.textContent = pageIds.length;
                    showPage(0);
                    loading.style.display = 'none';
                    console.log('Loaded ZIP from URL:', config);
                } catch (e) {
                    console.error(e);
                    alert('åŠ è½½ ZIP å¤±è´¥: ' + e.message);
                    loading.style.display = 'none';
                }
            }

            const urlParams = new URLSearchParams(window.location.search);
            const zipUrl = urlParams.get('zip');
            if (zipUrl) {
                console.log('Detected zip param:', zipUrl);
                loading.innerHTML = '<div class="loading-spinner"></div><p>æ­£åœ¨ä¸‹è½½èµ„æºåŒ…...</p>';
                loading.style.display = 'flex';
                fetch(zipUrl)
                    .then(res => {
                        if (!res.ok) throw new Error('Download failed: ' + res.status);
                        return res.blob();
                    })
                    .then(blob => loadFromZipBlob(blob))
                    .catch(e => {
                        alert('ä¸‹è½½å¤±è´¥: ' + e.message);
                        loading.style.display = 'none';
                    });
            }
        });
    </script>
</body>

</html>